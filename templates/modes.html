<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mode Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header class="navbar">
        <div class="nav-wrapper">
            <a href="/" class="logo"><h1>Smart<span>Home</span></h1></a>
            <div class="nav-links">
                <a href="/devices" class="btn-sm">
                    <svg viewBox="0 0 24 24" class="icon-svg"><path d="M4 11h6a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1zm10 0h6a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1h-6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1zM4 21h6a1 1 0 0 0 1-1v-6a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1zm10 0h6a1 1 0 0 0 1-1v-6a1 1 0 0 0-1-1h-6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1z"/></svg> 
                    <span>Devices</span>
                </a>
                <a href="/logout" class="btn-sm" style="color: #ff6b6b;">
                    <svg viewBox="0 0 24 24" class="icon-svg"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5a2 2 0 0 0-2 2v4h2V5h14v14H5v-4H3v4a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </header>

    <div class="container reveal">
        <div class="text-center" style="margin-bottom: 30px;">
            <h2>Routine <span>Modes</span></h2>
            <p>Automate your home environment.</p>
        </div>

        <div class="mode-wizard">
            <h3 style="text-align:center; margin-bottom: 25px;">Create New Schedule</h3>
            
            <form action="/save_mode" method="POST">
                
                <div class="wizard-section">
                    <div class="relay-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-weight:600; font-size:0.9rem;">Name</label>
                            <input type="text" name="mode_name" class="form-control" placeholder="e.g. Wake Up" required style="margin-bottom:0;">
                        </div>
                        <div>
                            <label style="font-weight:600; font-size:0.9rem;">Time</label>
                            <input type="time" name="start_time" class="form-control" required style="margin-bottom:0;">
                        </div>
                    </div>
                </div>

                <div class="wizard-section">
                    <div class="wizard-title">Repeat Days</div>
                    <div class="day-selector">
                        {% for day in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                        <label>
                            <input type="checkbox" name="days" value="{{ day }}" class="day-check" checked>
                            <span class="day-label">{{ day[0] }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="wizard-section">
                    <div class="wizard-title">Atmosphere</div>
                    <div class="audio-presets">
                        <label>
                            <input type="radio" name="audio_id" value="1" class="audio-radio">
                            <div class="audio-label"><span>‚òÄÔ∏è</span>Mrng</div>
                        </label>
                        <label>
                            <input type="radio" name="audio_id" value="2" class="audio-radio">
                            <div class="audio-label"><span>üåô</span>Night</div>
                        </label>
                        <label>
                            <input type="radio" name="audio_id" value="3" class="audio-radio">
                            <div class="audio-label"><span>üéâ</span>Party</div>
                        </label>
                        <label>
                            <input type="radio" name="audio_id" value="4" class="audio-radio">
                            <div class="audio-label"><span>üçÉ</span>Relax</div>
                        </label>
                        <label>
                            <input type="radio" name="audio_id" value="5" class="audio-radio">
                            <div class="audio-label"><span>üî•</span>Focus</div>
                        </label>
                    </div>
                </div>

                <div class="wizard-section">
                    <div class="wizard-title" style="display:flex; justify-content:space-between;">
                        <span>Device Actions</span>
                        <span style="font-size:0.7em; text-transform:none; opacity:0.7;">Unchecked = Turn OFF</span>
                    </div>
                    <div class="device-selector">
                        {% for room, devices in device_states.items() %}
                            {% for relay, data in devices.items() if relay.startswith('relay') %}
                            <div class="device-option">
                                <div>
                                    <div style="font-weight:500;">{{ data.label }}</div>
                                    <span style="font-size:0.8rem; opacity:0.6;">{{ room|replace('_', ' ')|title }}</span>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="action_{{ room }}_{{ relay }}">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>

                <button type="submit" class="btn-submit" style="width: 100%;">Save Schedule</button>
            </form>
        </div>

        <h3>Active Schedules</h3>
        <div class="mode-container">
            {% if modes %}
                {% for name, data in modes.items() %}
                <div class="mode-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0;">{{ name }}</h3>
                        <span style="font-size: 1.4em; font-weight: 700; color: var(--primary);">{{ data.start_time }}</span>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        {% for day in data.days %}
                        <span class="days-badge">{{ day }}</span>
                        {% endfor %}
                    </div>

                    <div style="background: var(--bg-body); padding: 15px; border-radius: 8px; font-size: 0.9em; margin-bottom: 20px;">
                        {% set ns = namespace(on_count=0, off_count=0) %}
                        {% if data.actions %}
                            {% for room_items in data.actions.values() %}
                                {% for state in room_items.values() %}
                                    {% if state == "ON" %} {% set ns.on_count = ns.on_count + 1 %}
                                    {% else %} {% set ns.off_count = ns.off_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        {% endif %}
                        
                        <div style="display:flex; gap: 15px;">
                            <div><span style="color:#28a745; font-weight:bold;">{{ ns.on_count }}</span> ON</div>
                            <div><span style="color:#ff4444; font-weight:bold;">{{ ns.off_count }}</span> OFF</div>
                        </div>

                        {% if data.audio_id %}
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                            <strong>üéµ Audio:</strong> 
                            {% if data.audio_id == 1 %}Morning
                            {% elif data.audio_id == 2 %}Night
                            {% elif data.audio_id == 3 %}Party
                            {% elif data.audio_id == 4 %}Relax
                            {% elif data.audio_id == 5 %}Focus
                            {% else %}Track #{{ data.audio_id }}
                            {% endif %}
                        </div>
                        {% endif %}
                        </div>

                    <form action="/delete_mode" method="POST" style="width:100%;">
                        <input type="hidden" name="mode_name" value="{{ name }}">
                        <button type="submit" class="btn-delete" style="width:100%; opacity:0.8;">Delete</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; border: 2px dashed var(--border-color); border-radius: 12px; color: var(--text-secondary);">
                    No schedules created yet.
                </div>
            {% endif %}
        </div>
    </div>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>