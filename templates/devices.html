<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Devices</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="text-center reveal">
            <p style="text-transform:uppercase; letter-spacing:2px; font-size:12px; margin-bottom:5px;">Setup</p>
            <h2>Device <span>Hub</span></h2>
        </div>

        <div class="text-center reveal" style="margin-bottom:40px; margin-top:20px;">
            <a href="/" class="btn-link" style="display:inline; margin-right:20px;">Dashboard</a>
            <a href="/add_room" class="btn-solid">Add New Room</a>
        </div>

        <h3 class="reveal">New Devices</h3>
        <div class="card-container reveal">
            {% if unassigned_devices %}
                {% for device_id, info in unassigned_devices.items() %}
                <div class="item-card">
                    <div class="item-header">
                        <span>{{ device_id }}</span>
                        <small style="opacity:0.7; font-size:12px; font-weight:400;">Seen: {{ info.last_seen }}</small>
                    </div>
                    <form method="post" action="/assign_device">
                        <input type="hidden" name="device_id" value="{{ device_id }}">
                        <select name="room_name" class="form-select" required>
                            <option value="">Choose a room...</option>
                            {% for room_name in device_states if room_name not in device_room_map %}
                            <option value="{{ room_name }}">{{ room_name|replace('_', ' ')|title }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn-action">Bind Device</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align:center; padding:30px; border:1px dashed var(--border-color); color:var(--text-secondary); grid-column: 1 / -1;">
                    No unassigned devices found.
                </div>
            {% endif %}
        </div>

        <h3 class="reveal">Active Rooms</h3>
        <div class="card-container reveal">
            {% for room_name, devices in device_states.items() %}
            <div class="item-card">
                <div class="item-header">
                    <span>{{ room_name|replace('_', ' ')|title }}</span>
                    {% if room_name in device_room_map %}
                        <svg class="icon-svg" style="color:var(--primary)" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    {% else %}
                        <svg class="icon-svg" style="color:#ccc" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                    {% endif %}
                </div>
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <a href="{{ url_for('edit_room_form', room=room_name) }}" class="btn-sm" style="flex:1; text-align:center;">Edit</a>
                    {% if room_name in device_room_map %}
                    <a href="{{ url_for('unbind_device_form', room=room_name) }}" class="btn-sm" style="flex:1; text-align:center;">Unbind</a>
                    {% endif %}
                    <a href="{{ url_for('remove_room_form', room=room_name) }}" class="btn-sm" style="flex:1; text-align:center; color:var(--primary); border-color:var(--primary);">Remove</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
